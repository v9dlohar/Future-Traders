{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Option Chain - Future Traders{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/optionchain.css' %}">
<style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); color: #1e293b; line-height: 1.6; }
        .container { padding: 0; width: 100%; max-width: 100%; }
        .header { background: #f6f8fa; border-bottom: 1px solid #d0d7de; padding: 16px 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .header h2 { color: #24292f; font-size: 18px; font-weight: 600; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
        .controls { display: flex; gap: 16px; align-items: center; margin-top: 12px; }
        .control-group { position: relative; }
        .control-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #656d76; font-size: 13px; }
        .control-group input { padding: 10px 14px; border: 1px solid #d0d7de; border-radius: 8px; font-size: 13px; background: #ffffff; color: #24292f; min-width: 130px; transition: all 0.3s ease; }
        .control-group input:focus { outline: none; border-color: #0969da; box-shadow: 0 0 0 2px rgba(9, 105, 218, 0.2); transform: translateY(-1px); }
        .dropdown { position: absolute; top: 100%; left: 0; background: #ffffff; border: 1px solid #d0d7de; border-radius: 8px; max-height: 300px; overflow-y: scroll; display: none; z-index: 1000; width: 100%; box-shadow: 0 8px 24px rgba(0,0,0,0.1); scrollbar-width: thin; scrollbar-color: #d0d7de #ffffff; }
        .dropdown::-webkit-scrollbar { width: 8px; }
        .dropdown::-webkit-scrollbar-track { background: #f6f8fa; border-radius: 4px; }
        .dropdown::-webkit-scrollbar-thumb { background: #d0d7de; border-radius: 4px; }
        .dropdown::-webkit-scrollbar-thumb:hover { background: #b0b7be; }
        .dropdown div { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #d0d7de; font-size: 14px; color: #24292f; transition: background 0.2s; }
        .dropdown div:hover { background-color: #f6f8fa; }
        .dropdown div:last-child { border-bottom: none; }
        .market-info { background: #f6f8fa; padding: 12px 24px; border-bottom: 1px solid #d0d7de; display: flex; align-items: center; gap: 24px; }
        .symbol-info { display: flex; align-items: center; gap: 16px; }
        .symbol-name { font-size: 16px; font-weight: 700; color: #24292f; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
        .ltp-info { display: flex; align-items: center; gap: 8px; }
        .ltp-value { font-size: 18px; font-weight: 800; color: #1a7f37; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
        .table-container { background: #ffffff; margin: 0; overflow-x: auto; max-height: calc(100vh - 200px); overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: auto; }
        th { background: #f6f8fa; color: #656d76; padding: 10px 8px; text-align: center; font-weight: 700; font-size: 12px; border-bottom: 1px solid #d0d7de; position: sticky; top: 0; z-index: 10; text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: 8px 6px; text-align: center; border-bottom: 1px solid #d0d7de; font-size: 12px; transition: background 0.2s; }
        tbody tr:hover { background: #f6f8fa; }
        .calls-header { background: #dafbe1 !important; color: #1a7f37 !important; }
        .puts-header { background: #ffebe9 !important; color: #cf222e !important; }
        .strike-header { background: #fff8c5 !important; color: #9a6700 !important; }
        .call-data { color: #1a7f37; font-weight: 500; }
        .put-data { color: #cf222e; font-weight: 500; }
        .strike-price { background: #f6f8fa !important; color: #9a6700 !important; font-weight: 800; font-size: 13px; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
        .positive { color: #1a7f37; font-weight: 700; }
        .negative { color: #cf222e; font-weight: 700; }
        .highlight-max { background: rgba(5, 150, 105, 0.3) !important; }
        .ltp-line { border-top: 2px solid #0969da; background: linear-gradient(90deg, transparent, rgba(9, 105, 218, 0.2), transparent); position: relative; }
        .ltp-line::after { content: attr(data-ltp); position: absolute; left: 50%; top: -11px; transform: translateX(-50%); background: linear-gradient(135deg, #0969da 0%, #2563eb 50%, #1d4ed8 100%); color: white; padding: 2px 8px; font-size: 9px; font-weight: 600; border-radius: 4px; box-shadow: 0 2px 8px rgba(9, 105, 218, 0.4), 0 1px 3px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2); letter-spacing: 0.5px; }
        .volume-bar { height: 3px; background: #e9ecef; border-radius: 2px; margin-top: 4px; overflow: hidden; }
        .volume-fill { height: 100%; background: linear-gradient(90deg, #0969da, #2563eb); border-radius: 2px; transition: width 0.3s; }
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container { padding: 5px; }
            .header { padding: 12px; }
            .controls { flex-direction: column; align-items: stretch; gap: 12px; }
            .control-group { width: 100%; }
            .control-group input { min-width: 100%; }
            .market-info { flex-direction: column; align-items: flex-start; gap: 12px; padding: 12px; }
            .table-container { margin: 0 -5px; max-height: calc(100vh - 250px); }
            table { font-size: 10px; min-width: 600px; }
            th, td { padding: 6px 4px; }
            .symbol-name { font-size: 14px; }
            .ltp-value { font-size: 16px; }
        }
        
        /* Tablet Responsive */
        @media (min-width: 769px) and (max-width: 1024px) {
            .controls { justify-content: center; flex-wrap: wrap; }
            .control-group { min-width: 200px; }
            table { font-size: 11px; }
            th, td { padding: 7px 5px; }
        }
        
        /* Large Screen */
        @media (min-width: 1025px) {
            table { font-size: 12px; }
            th, td { padding: 8px 6px; }
        }
</style>
{% endblock %}

{% block content %}
    <div class="container">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2>Welcome, {{ user.first_name }} {{ user.last_name }}</h2>
            </div>
            <div class="controls">
                <div class="control-group">
                    <label>Symbol</label>
                    <input type="text" id="symbolInput" value="NSE:NIFTY50-INDEX" placeholder="Search symbol..." autocomplete="off">
                    <div id="symbolDropdown" class="dropdown"></div>
                </div>
                <div class="control-group">
                    <label>Expiry Date</label>
                    <input type="text" id="expiryInput" value="20-10-2025" placeholder="Search expiry..." autocomplete="off">
                    <div id="expiryDropdown" class="dropdown"></div>
                </div>
                <div class="control-group">
                    <label>Strike Count</label>
                    <input type="text" id="strikeInput" value="10" placeholder="Strike count..." autocomplete="off" readonly>
                    <div id="strikeDropdown" class="dropdown"></div>
                </div>
                <div style="margin-left: auto; background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.1)); border: 2px solid rgba(59, 130, 246, 0.4); border-radius: 12px; padding: 12px 20px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);">
                    <label style="display: block; margin-bottom: 10px; font-weight: 700; color: #1e40af; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">Greeks</label>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; color: #1f2937; font-size: 13px; margin: 0; font-weight: 600; transition: all 0.2s; padding: 4px 8px; border-radius: 6px;">
                            <input type="checkbox" id="ivCheck" style="cursor: pointer; width: 17px; height: 17px; accent-color: #3b82f6;"> IV
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; color: #1f2937; font-size: 13px; margin: 0; font-weight: 600; transition: all 0.2s; padding: 4px 8px; border-radius: 6px;">
                            <input type="checkbox" id="deltaCheck" checked style="cursor: pointer; width: 17px; height: 17px; accent-color: #3b82f6;"> Delta
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; color: #1f2937; font-size: 13px; margin: 0; font-weight: 600; transition: all 0.2s; padding: 4px 8px; border-radius: 6px;">
                            <input type="checkbox" id="gammaCheck" style="cursor: pointer; width: 17px; height: 17px; accent-color: #3b82f6;"> Gamma
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; color: #1f2937; font-size: 13px; margin: 0; font-weight: 600; transition: all 0.2s; padding: 4px 8px; border-radius: 6px;">
                            <input type="checkbox" id="thetaCheck" style="cursor: pointer; width: 17px; height: 17px; accent-color: #3b82f6;"> Theta
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; color: #1f2937; font-size: 13px; margin: 0; font-weight: 600; transition: all 0.2s; padding: 4px 8px; border-radius: 6px;">
                            <input type="checkbox" id="vegaCheck" style="cursor: pointer; width: 17px; height: 17px; accent-color: #3b82f6;"> Vega
                        </label>
                    </div>
                </div>
            </div>
        </div>
        <div class="market-info">
            <div class="symbol-info">
                <div class="symbol-name" id="currentSymbol">NIFTY50</div>
                <div class="ltp-info">
                    <span style="color: #8b949e; font-size: 14px;">LTP:</span>
                    <span class="ltp-value" id="symbolLTP">0</span>
                    <span class="change-info" id="changeInfo" style="margin-left: 12px; font-size: 14px; font-weight: 600;"></span>
                </div>
                <div class="ltp-info" style="margin-left: 24px;">
                    <span style="color: #8b949e; font-size: 14px; font-weight: bold;">PCR:</span>
                    <span class="ltp-value" id="pcrValue" style="color: #3b82f6;">0.00</span>
                </div>
            </div>
        </div>
        <div class="table-container" id="optionchain-container">
        <table>
            <thead>
                <tr>
                    <th colspan="12" class="calls-header">CALLS</th>
                    <th class="strike-header">STRIKE</th>
                    <th colspan="12" class="puts-header">PUTS</th>
                </tr>
                <tr>
                    <th class="calls-header">OI CH</th>
                    <th class="calls-header">OI</th>
                    <th class="calls-header">%MCOI</th>
                    <th class="calls-header">VOLUME</th>
                    <th class="calls-header">%MCV</th>
                    <th class="calls-header">LTP CH</th>
                    <th class="calls-header">IV</th>
                    <th class="calls-header">GAMMA</th>
                    <th class="calls-header">THETA</th>
                    <th class="calls-header">VEGA</th>
                    <th class="calls-header">DELTA</th>
                    <th class="calls-header">LTP</th>
                    <th class="strike-header">PRICE</th>
                    <th class="puts-header">LTP</th>
                    <th class="puts-header">DELTA</th>
                    <th class="puts-header">VEGA</th>
                    <th class="puts-header">THETA</th>
                    <th class="puts-header">GAMMA</th>
                    <th class="puts-header">IV</th>
                    <th class="puts-header">LTP CH</th>
                    <th class="puts-header">%MPV</th>
                    <th class="puts-header">VOLUME</th>
                    <th class="puts-header">%MPOI</th>
                    <th class="puts-header">OI</th>
                    <th class="puts-header">OI CH</th>
                </tr>
            </thead>
            <tbody>

            </tbody>
            </table>
        </div>
    </div>

    <script src="{% static 'dashboard/optionchain.js' %}"></script>
    <script>
        // ========== GLOBAL VARIABLES ==========
        // Symbol and expiry data
        let allSymbols = [];              // All available symbols from JSON
        let allExpiries = [];             // All valid expiries for selected symbol
        let symbolData = {};              // Complete symbol-expiry mapping from JSON
        
        // Dropdown navigation state
        let selectedIndex = -1;           // Currently selected index in symbol dropdown
        let filteredSymbols = [];         // Filtered symbols based on search
        let expirySelectedIndex = -1;     // Currently selected index in expiry dropdown
        let filteredExpiries = [];        // Filtered expiries based on search
        
        // Active selection state
        let previousSymbol = '';          // Store previous symbol when input is cleared
        let previousExpiry = '';          // Store previous expiry when input is cleared
        let activeSymbol = 'NSE:NIFTY50-INDEX';  // Currently active symbol for data fetch
        let activeExpiry = '';            // Currently active expiry for data fetch
        let activeStrikeCount = 10;       // Currently active strike count
        let strikeOptions = [8, 10, 15, 20];  // Available strike count options
        
        // Greeks visibility state - tracks which Greek columns are visible
        // By default only Delta is checked
        let selectedGreeks = {
            'IV': false,
            'DELTA': true,
            'GAMMA': false,
            'THETA': false,
            'VEGA': false
        };
        
        // Request management
        let currentRequestId = 0;         // Track latest request to prevent race conditions
        
        // ========== GREEKS CHECKBOX LISTENERS ==========
        // Setup event listeners for Greeks visibility checkboxes
        document.getElementById('ivCheck').addEventListener('change', function() {
            selectedGreeks['IV'] = this.checked;
            toggleGreeksColumns();  // Show/hide IV columns
        });
        document.getElementById('deltaCheck').addEventListener('change', function() {
            selectedGreeks['DELTA'] = this.checked;
            toggleGreeksColumns();  // Show/hide Delta columns
        });
        document.getElementById('gammaCheck').addEventListener('change', function() {
            selectedGreeks['GAMMA'] = this.checked;
            toggleGreeksColumns();  // Show/hide Gamma columns
        });
        document.getElementById('thetaCheck').addEventListener('change', function() {
            selectedGreeks['THETA'] = this.checked;
            toggleGreeksColumns();  // Show/hide Theta columns
        });
        document.getElementById('vegaCheck').addEventListener('change', function() {
            selectedGreeks['VEGA'] = this.checked;
            toggleGreeksColumns();  // Show/hide Vega columns
        });
        
        // ========== GREEKS COLUMN VISIBILITY TOGGLE ==========
        /**
         * Show/hide Greeks columns based on checkbox selection
         * Updates both column headers and data cells
         * Adjusts colspan for CALLS and PUTS headers dynamically
         */
        function toggleGreeksColumns() {
            const secondHeaderRow = document.querySelectorAll('thead tr')[1];
            
            // Map Greek names to their column indices in the table (0-indexed)
            // Format: [CALL column index, PUT column index]
            // CALL: LTP CH, IV, GAMMA, THETA, VEGA, DELTA, LTP
            // PUT: LTP, DELTA, VEGA, THETA, GAMMA, IV, LTP CH
            const greekColumns = {
                'IV': [6, 18],      // Implied Volatility columns
                'GAMMA': [7, 17],   // Gamma columns
                'THETA': [8, 16],   // Theta columns
                'VEGA': [9, 15],    // Vega columns
                'DELTA': [10, 14]   // Delta columns
            };
            
            // Map Greek names to their CSS class names for data cells
            const greekClassMap = {
                'IV': 'greek-iv',
                'DELTA': 'greek-delta',
                'GAMMA': 'greek-gamma',
                'THETA': 'greek-theta',
                'VEGA': 'greek-vega'
            };
            
            // Count visible columns to update colspan
            // Base: 7 columns (OI CH, OI, %MCOI, VOLUME, %MCV, LTP CH, LTP)
            let visibleCallsCount = 7;
            let visiblePutsCount = 7;
            Object.keys(greekColumns).forEach(greek => {
                if (selectedGreeks[greek]) {
                    visibleCallsCount++;
                    visiblePutsCount++;
                }
            });
            
            // Update colspan for CALLS and PUTS headers in first row
            const firstHeaderRow = document.querySelectorAll('thead tr')[0];
            if (firstHeaderRow) {
                firstHeaderRow.children[0].setAttribute('colspan', visibleCallsCount);  // CALLS header
                firstHeaderRow.children[2].setAttribute('colspan', visiblePutsCount);   // PUTS header
            }
            
            // Show/hide columns based on checkbox selection
            Object.keys(greekColumns).forEach(greek => {
                const show = selectedGreeks[greek];
                const className = greekClassMap[greek];
                
                // Hide/show column headers
                greekColumns[greek].forEach(colIndex => {
                    if (secondHeaderRow && secondHeaderRow.children[colIndex]) {
                        secondHeaderRow.children[colIndex].style.display = show ? '' : 'none';
                    }
                });
                
                // Hide/show all data cells with matching class
                document.querySelectorAll(`.${className}`).forEach(cell => {
                    cell.style.display = show ? '' : 'none';
                });
            });
        }
        
        // ========== UTILITY FUNCTIONS ==========
        /**
         * Filter out expired dates from expiry list
         * @param {Array} expiries - Array of expiry dates in DD-MM-YYYY format
         * @returns {Array} - Filtered array with only future dates
         */
        function filterValidExpiries(expiries) {
            const today = new Date();
            return expiries.filter(expiry => {
                const [day, month, year] = expiry.split('-');
                const expiryDate = new Date(year, month - 1, day);
                return expiryDate >= today;  // Keep only future dates
            });
        }
        
        /**
         * Format numbers in Indian numbering system (lakhs, crores)
         * @param {number} value - Number to format
         * @returns {string} - Formatted string (e.g., 1,23,456)
         */
        function formatIndian(value) {
            const num = parseInt(value);
            return num.toLocaleString('en-IN');
        }
        
        // ========== INITIALIZATION ==========
        // Load symbols and expiries from JSON file on page load
        fetch('{% static "symbol.json" %}?v=' + Date.now())
            .then(response => response.json())
            .then(data => {
                symbolData = data.expiry_dates;
                allSymbols = Object.keys(data.expiry_dates);
                allExpiries = filterValidExpiries(data.expiry_dates['NSE:NIFTY50-INDEX'] || []);
                document.getElementById('symbolInput').value = 'NSE:NIFTY50-INDEX';
                document.getElementById('expiryInput').value = allExpiries[0] || '';
                // Set initial active values
                activeSymbol = 'NSE:NIFTY50-INDEX';
                activeExpiry = allExpiries[0] || '';
                // Load initial data
                setTimeout(() => {
                    updateData();
                }, 500);
            })
            .catch(error => console.error('Error loading symbols:', error));
        
        // ========== EXPIRY DROPDOWN FUNCTIONS ==========
        /**
         * Display expiry dates in dropdown
         * @param {Array} expiries - Array of expiry dates to display
         */
        function showExpiries(expiries) {
            filteredExpiries = expiries;
            expirySelectedIndex = -1;
            const dropdown = document.getElementById('expiryDropdown');
            dropdown.innerHTML = '';
            dropdown.style.display = 'block';
            
            expiries.forEach((expiry, index) => {
                const div = document.createElement('div');
                div.textContent = expiry;
                div.style.padding = '8px';
                div.style.cursor = 'pointer';
                div.style.borderBottom = '1px solid #eee';
                div.className = 'expiry-option';
                div.onclick = () => {
                    document.getElementById('expiryInput').value = expiry;
                    dropdown.style.display = 'none';
                    // Update active expiry IMMEDIATELY for data rendering
                    activeExpiry = expiry;
                    // Update immediately
                    immediateUpdate();
                };
                dropdown.appendChild(div);
            });
        }
        
        /**
         * Update visual selection in expiry dropdown (keyboard navigation)
         */
        function updateExpirySelection() {
            const options = document.querySelectorAll('.expiry-option');
            options.forEach((option, index) => {
                if (index === expirySelectedIndex) {
                    option.style.backgroundColor = '#007bff';
                    option.style.color = 'white';
                    option.scrollIntoView({ block: 'nearest' });
                } else {
                    option.style.backgroundColor = 'white';
                    option.style.color = 'black';
                }
            });
        }
        
        // ========== SYMBOL DROPDOWN FUNCTIONS ==========
        /**
         * Display symbols in dropdown
         * @param {Array} symbols - Array of symbols to display
         */
        function showSymbols(symbols) {
            filteredSymbols = symbols;
            selectedIndex = -1;
            const dropdown = document.getElementById('symbolDropdown');
            dropdown.innerHTML = '';
            dropdown.style.display = 'block';
            
            symbols.forEach((symbol, index) => {
                const div = document.createElement('div');
                div.textContent = symbol;
                div.style.padding = '8px';
                div.style.cursor = 'pointer';
                div.style.borderBottom = '1px solid #eee';
                div.className = 'symbol-option';
                div.onclick = () => {
                    document.getElementById('symbolInput').value = symbol;
                    dropdown.style.display = 'none';
                    // Update expiry dates for selected symbol with valid dates only
                    allExpiries = filterValidExpiries(symbolData[symbol] || []);
                    const newExpiry = allExpiries[0] || '';
                    document.getElementById('expiryInput').value = newExpiry;
                    // Update active values IMMEDIATELY for data rendering
                    activeSymbol = symbol;
                    activeExpiry = newExpiry;
                    // Update symbol display
                    document.getElementById('currentSymbol').textContent = symbol.replace('NSE:', '').replace('-INDEX', '');
                    // Update immediately
                    immediateUpdate();
                };
                dropdown.appendChild(div);
            });
        }
        
        /**
         * Update visual selection in symbol dropdown (keyboard navigation)
         */
        function updateSelection() {
            const options = document.querySelectorAll('.symbol-option');
            options.forEach((option, index) => {
                if (index === selectedIndex) {
                    option.style.backgroundColor = '#007bff';
                    option.style.color = 'white';
                    option.scrollIntoView({ block: 'nearest' });
                } else {
                    option.style.backgroundColor = 'white';
                    option.style.color = 'black';
                }
            });
        }
        

        
        // ========== SYMBOL INPUT EVENT LISTENERS ==========
        // Store previous values and show ALL symbols on focus
        document.getElementById('symbolInput').addEventListener('focus', function() {
            if (this.value) {
                previousSymbol = this.value;
                previousExpiry = document.getElementById('expiryInput').value;
            }
            this.value = '';
            // Show ALL symbols, not just indices
            showSymbols(allSymbols);
        });
        
        // Filter symbols on input
        document.getElementById('symbolInput').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const filtered = allSymbols.filter(symbol => 
                symbol.toLowerCase().includes(searchTerm)
            );
            showSymbols(filtered);
        });
        
        // Handle keyboard navigation
        document.getElementById('symbolInput').addEventListener('keydown', function(e) {
            const dropdown = document.getElementById('symbolDropdown');
            if (dropdown.style.display === 'none') return;
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, filteredSymbols.length - 1);
                updateSelection();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelection();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIndex >= 0 && selectedIndex < filteredSymbols.length) {
                    const selectedSymbol = filteredSymbols[selectedIndex];
                    this.value = selectedSymbol;
                    dropdown.style.display = 'none';
                    // Update expiry dates for selected symbol with valid dates only
                    allExpiries = filterValidExpiries(symbolData[selectedSymbol] || []);
                    const newExpiry = allExpiries[0] || '';
                    document.getElementById('expiryInput').value = newExpiry;
                    // Update active values IMMEDIATELY for data rendering
                    activeSymbol = selectedSymbol;
                    activeExpiry = newExpiry;
                    // Update symbol display
                    document.getElementById('currentSymbol').textContent = selectedSymbol.replace('NSE:', '').replace('-INDEX', '');
                    // Update immediately
                    immediateUpdate();
                }
            } else if (e.key === 'Escape') {
                dropdown.style.display = 'none';
            }
        });
        
        // ========== EXPIRY INPUT EVENT LISTENERS ==========
        
        document.getElementById('expiryInput').addEventListener('focus', function() {
            showExpiries(allExpiries);
        });
        
        document.getElementById('expiryInput').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const filtered = allExpiries.filter(expiry => 
                expiry.toLowerCase().includes(searchTerm)
            );
            showExpiries(filtered);
        });
        
        document.getElementById('expiryInput').addEventListener('keydown', function(e) {
            const dropdown = document.getElementById('expiryDropdown');
            if (dropdown.style.display === 'none') return;
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                expirySelectedIndex = Math.min(expirySelectedIndex + 1, filteredExpiries.length - 1);
                updateExpirySelection();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                expirySelectedIndex = Math.max(expirySelectedIndex - 1, -1);
                updateExpirySelection();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (expirySelectedIndex >= 0 && expirySelectedIndex < filteredExpiries.length) {
                    const selectedExpiry = filteredExpiries[expirySelectedIndex];
                    this.value = selectedExpiry;
                    dropdown.style.display = 'none';
                    // Update active expiry IMMEDIATELY for data rendering
                    activeExpiry = selectedExpiry;
                    // Update immediately
                    immediateUpdate();
                }
            } else if (e.key === 'Escape') {
                dropdown.style.display = 'none';
            }
        });
        
        // ========== GLOBAL CLICK HANDLER ==========
        // Hide dropdowns when clicking outside and restore previous values if no selection made
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#symbolInput') && !e.target.closest('#symbolDropdown')) {
                const symbolInput = document.getElementById('symbolInput');
                if (symbolInput.value === '' && previousSymbol) {
                    symbolInput.value = previousSymbol;
                    document.getElementById('expiryInput').value = previousExpiry;
                }
                document.getElementById('symbolDropdown').style.display = 'none';
            }
            if (!e.target.closest('#expiryInput') && !e.target.closest('#expiryDropdown')) {
                document.getElementById('expiryDropdown').style.display = 'none';
            }
            if (!e.target.closest('#strikeInput') && !e.target.closest('#strikeDropdown')) {
                document.getElementById('strikeDropdown').style.display = 'none';
            }
        });
        
        // ========== STRIKE COUNT DROPDOWN ==========
        /**
         * Display strike count options in dropdown
         */
        function showStrikes() {
            const dropdown = document.getElementById('strikeDropdown');
            dropdown.innerHTML = '';
            dropdown.style.display = 'block';
            
            strikeOptions.forEach(strike => {
                const div = document.createElement('div');
                div.textContent = strike;
                div.style.padding = '8px';
                div.style.cursor = 'pointer';
                div.style.borderBottom = '1px solid #eee';
                div.onclick = () => {
                    document.getElementById('strikeInput').value = strike;
                    dropdown.style.display = 'none';
                    // Update active strike count IMMEDIATELY
                    activeStrikeCount = strike;
                    // Update immediately
                    immediateUpdate();
                };
                dropdown.appendChild(div);
            });
        }
        
        document.getElementById('strikeInput').addEventListener('focus', function() {
            showStrikes();
        });
        
        // ========== DATA UPDATE FUNCTIONS ==========
        /**
         * Trigger immediate data update (called when user changes selection)
         */
        function immediateUpdate() {
            showLoadingState();
            currentRequestId++;  // Increment to cancel any pending requests
            updateData();
        }
        
        /**
         * Show loading state in table
         */
        function showLoadingState() {
            const tbody = document.querySelector('#optionchain-container tbody');
            tbody.innerHTML = '<tr><td colspan="25" style="text-align: center; padding: 40px; color: #8b949e; font-size: 18px; font-weight: 600;">Loading...</td></tr>';
        }
        
        /**
         * Fetch option chain data from server and update table
         * Handles race conditions using requestId
         * Updates LTP, PCR, and highlights max values
         */
        function updateData() {
            // Validate required parameters
            if (!activeSymbol || !activeExpiry) return;
            
            const requestId = ++currentRequestId;
            const requestSymbol = activeSymbol;
            const requestExpiry = activeExpiry;
            const requestStrike = activeStrikeCount;
            
            // Add timeout for faster response
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);
            
            fetch(`{% url "get_live_data" %}?symbol=${activeSymbol}&expiry=${activeExpiry}&strikecount=${activeStrikeCount}`, {
                signal: controller.signal
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(result => {
                    // Only update if this is the latest request
                    if (requestId !== currentRequestId) return;
                    // Double check symbol/expiry/strike haven't changed
                    if (requestSymbol !== activeSymbol || requestExpiry !== activeExpiry || requestStrike !== activeStrikeCount) return;
                    const tbody = document.querySelector('#optionchain-container tbody');
                    tbody.innerHTML = '';
                    
                    // Update LTP and change info in header
                    if (result.quote_data) {
                        const quote = result.quote_data;
                        document.getElementById('symbolLTP').textContent = quote.ltp || '0';
                        
                        // Update change info
                        const changeInfo = document.getElementById('changeInfo');
                        if (quote.change_points !== undefined && quote.change_percent !== undefined) {
                            const isPositive = quote.change_points >= 0;
                            const sign = isPositive ? '+' : '';
                            changeInfo.innerHTML = `${sign}${quote.change_points} (${sign}${quote.change_percent}%)`;
                            changeInfo.style.color = isPositive ? '#10b981' : '#ef4444';
                        } else {
                            changeInfo.textContent = '';
                        }
                    } else {
                        document.getElementById('symbolLTP').textContent = '0';
                        document.getElementById('changeInfo').textContent = '';
                    }
                    
                    if (!result.data || result.data.length === 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = '<td colspan="25" style="text-align: center; padding: 20px;">No data available for selected symbol and expiry</td>';
                        tbody.appendChild(tr);
                        return;
                    }
                    
                    // Populate table rows with option chain data
                    result.data.forEach(row => {
                        const tr = document.createElement('tr');
                        // Build table row with all columns
                        // Greek columns have special classes (greek-iv, greek-delta, etc.) for visibility toggle
                        tr.innerHTML = `
                            <td class="call-data call-oich">${formatIndian(row.CALL_OICH)}</td>
                            <td class="call-data call-oi">${formatIndian(row.CALL_OI)}</td>
                            <td class="call-data call-pmcoi">${row.CALL_PMCOI}%</td>
                            <td class="call-data call-volume">${formatIndian(row.CALL_VOLUME)}</td>
                            <td class="call-data call-pmcv">${row.CALL_PMCV}%</td>
                            <td class="call-data ${row.CALL_LTPCH >= 0 ? 'positive' : 'negative'}">${row.CALL_LTPCH}</td>
                            <td class="call-data greek-iv">${row.CALL_IV}%</td>
                            <td class="call-data greek-gamma">${row.CALL_GAMMA}</td>
                            <td class="call-data greek-theta">${row.CALL_THETA}</td>
                            <td class="call-data greek-vega">${row.CALL_VEGA}</td>
                            <td class="call-data greek-delta">${row.CALL_DELTA}</td>
                            <td class="call-data" style="font-weight: 600;">${row.CALL_LTP}</td>
                            <td class="strike-price">${row.STRIKE_PRICE}</td>
                            <td class="put-data" style="font-weight: 600;">${row.PUT_LTP}</td>
                            <td class="put-data greek-delta">${row.PUT_DELTA}</td>
                            <td class="put-data greek-vega">${row.PUT_VEGA}</td>
                            <td class="put-data greek-theta">${row.PUT_THETA}</td>
                            <td class="put-data greek-gamma">${row.PUT_GAMMA}</td>
                            <td class="put-data greek-iv">${row.PUT_IV}%</td>
                            <td class="put-data ${row.PUT_LTPCH >= 0 ? 'positive' : 'negative'}">${row.PUT_LTPCH}</td>
                            <td class="put-data put-pmpv">${row.PUT_PMPV}%</td>
                            <td class="put-data put-volume">${formatIndian(row.PUT_VOLUME)}</td>
                            <td class="put-data put-pmpoi">${row.PUT_PMPOI}%</td>
                            <td class="put-data put-oi">${formatIndian(row.PUT_OI)}</td>
                            <td class="put-data put-oich">${formatIndian(row.PUT_OICH)}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    // Apply Greeks column visibility based on checkbox state
                    toggleGreeksColumns();
                    
                    // Add LTP line after table is rebuilt
                    if (result.quote_data && result.quote_data.ltp) {
                        addLTPLine(result.quote_data.ltp, result.data);
                    }
                    
                    // Highlight maximum values
                    highlightMaxValues();
                    
                    // Update PCR
                    if (result.pcr !== undefined) {
                        const pcrValue = document.getElementById('pcrValue');
                        pcrValue.textContent = result.pcr.toFixed(2);
                        pcrValue.style.color = result.pcr > 1 ? '#10b981' : result.pcr < 1 ? '#ef4444' : '#3b82f6';
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        console.log('Request timeout - retrying...');
                        // Retry after timeout
                        setTimeout(() => {
                            if (requestId === currentRequestId) {
                                updateData();
                            }
                        }, 1000);
                    } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        console.log('Network error - continuing with next update');
                        // Don't show error, just continue with next update cycle
                    } else {
                        console.error('Error fetching data:', error);
                        const tbody = document.querySelector('#optionchain-container tbody');
                        if (tbody.children.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="25" style="text-align: center; padding: 20px; color: #ef4444;">Reconnecting...</td></tr>';
                        }
                    }
                })
                .finally(() => {
                    clearTimeout(timeoutId);
                });
        }
        
        // ========== LTP LINE DISPLAY ==========
        /**
         * Add visual LTP line between strike prices where current LTP falls
         * @param {number} ltp - Last Traded Price
         * @param {Array} data - Option chain data array
         */
        function addLTPLine(ltp, data) {
            // Remove existing LTP line rows
            document.querySelectorAll('.ltp-line-row').forEach(row => {
                row.remove();
            });
            
            const tbody = document.querySelector('#optionchain-container tbody');
            const rows = document.querySelectorAll('#optionchain-container tbody tr');
            const ltpValue = parseFloat(ltp);
            
            // Find position between two strikes where LTP lies
            for (let i = 0; i < data.length - 1; i++) {
                const currentStrike = parseFloat(data[i].STRIKE_PRICE);
                const nextStrike = parseFloat(data[i + 1].STRIKE_PRICE);
                
                if (ltpValue > currentStrike && ltpValue < nextStrike) {
                    // Create LTP line row
                    const ltpRow = document.createElement('tr');
                    ltpRow.className = 'ltp-line-row';
                    ltpRow.innerHTML = `<td colspan="25" style="padding: 0; position: relative; height: 4px; background: linear-gradient(90deg, #dc2626, #ef4444, #dc2626); border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.3);"><div style="position: absolute; left: 50%; top: -9px; transform: translateX(-50%); background: linear-gradient(135deg, #dc2626 0%, #ef4444 50%, #b91c1c 100%); color: white; padding: 2px 8px; font-size: 9px; font-weight: 600; border-radius: 4px; box-shadow: 0 2px 8px rgba(220, 38, 38, 0.4), 0 1px 3px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2); letter-spacing: 0.5px;">${ltp}</div></td>`;
                    
                    // Insert after current row
                    if (rows[i] && rows[i].nextSibling) {
                        tbody.insertBefore(ltpRow, rows[i].nextSibling);
                    } else if (rows[i]) {
                        rows[i].insertAdjacentElement('afterend', ltpRow);
                    }
                    break;
                }
            }
        }
        
        // ========== HIGHLIGHT MAX VALUES ==========
        /**
         * Highlight cells with maximum values in each column
         * Applies to OI, Volume, and percentage columns
         */
        function highlightMaxValues() {
            const columns = ['call-oich', 'call-oi', 'call-pmcoi', 'call-volume', 'call-pmcv', 'put-oich', 'put-oi', 'put-pmpoi', 'put-volume', 'put-pmpv'];
            
            columns.forEach(column => {
                const cells = document.querySelectorAll(`.${column}`);
                let maxValue = -Infinity;
                let maxCell = null;
                
                cells.forEach(cell => {
                    const value = parseFloat(cell.textContent.replace(/[,%]/g, ''));
                    if (value > maxValue) {
                        maxValue = value;
                        maxCell = cell;
                    }
                });
                
                // Remove previous highlights
                cells.forEach(cell => cell.classList.remove('highlight-max'));
                
                // Highlight maximum value
                if (maxCell) {
                    maxCell.classList.add('highlight-max');
                }
            });
        }
        
        // ========== PERIODIC DATA REFRESH ==========
        // Auto-refresh option chain data every 2 seconds
        setInterval(() => {
            if (activeSymbol && activeExpiry) {
                updateData();
            }
        }, 2000);
    </script>
{% endblock %}
